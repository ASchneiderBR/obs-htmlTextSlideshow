---
description: Project standards, architecture, and privacy rules for OBS Text Slideshow
globs: 
  - "**/*"
alwaysApply: true
---
# OBS Text Slideshow - Project Rules (v2.0)

## Project Overview
**Version 2.0** simplifies the architecture into three standalone files:
1. **Dock.html**: A fully bundled browser dock for editing slides and controlling playback (all CSS/JS inline).
2. **Source.html**: A fully bundled browser overlay displayed in OBS scenes (all CSS/JS inline).
3. **text-slides.lua**: Lua script for OBS that handles global hotkeys and displays installation paths.

**Distribution**: The project is distributed via GitHub Releases as a ZIP file (`htmlTextSlideshow-X.Y.Z.zip`) containing the core files directly in the root (no subfolder). Users extract the ZIP and load the Lua script in OBS.

## Tech Stack
- **Frontend**: Vanilla JavaScript (ES5 for maximum compatibility), HTML5, CSS3.
- **OBS Integration**: Lua (obslua).
- **No Build Step**: The project runs directly from source. All files are standalone and self-contained.
- **No External Dependencies**: Everything is bundled inline—no CDN links, no npm packages, no modules.

## Architecture & Data Flow (v2.0)

### 1. Slide State
- **Source of Truth**: The Dock (`Dock.html`) holds the state in memory and localStorage.
- **Persistence**: 
  - **Primary**: `localStorage` with key `obsTextSlides.state` (per OBS profile, survives restarts).
  - **Fallback**: `slides.json` (auto-generated backup for JSON polling mode if BroadcastChannel fails).
  - **Warning**: Both localStorage and `slides.json` may contain private user content (slides). Treat as user data, not configuration.

### 2. Communication
- **Primary**: `BroadcastChannel` API (channel name: `obs-text-slides`).
  - Real-time sync between Dock and Source within the same OBS instance.
  - No network requests, no file I/O—just in-memory messaging.
- **Fallback**: JSON Polling.
  - If `BroadcastChannel` is unavailable (older browsers, permission issues), Source polls `slides.json` every 2 seconds.
  - Dock does NOT write to `slides.json` in v2.0 unless explicitly enabled.

### 3. Hotkeys (Critical Flow)
- **Lua Script** (`obs-text-slides.lua`): Listens for global hotkeys (Next/Prev/First) registered in OBS Settings > Hotkeys.
- **Bridge File** (`hotkeys.js`): When a key is pressed, Lua writes a command object to this file:
  ```javascript
  window.__obsTextSlidesHotkey = { seq: 123, command: "next" };
  ```
- **Dock Polling**: Every 1 second, Dock injects a `<script>` tag pointing to `hotkeys.js?t=<timestamp>`, reads the command, and updates the slide state.
- **Source Reaction**: Dock broadcasts the new state via BroadcastChannel, and Source updates instantly.
- **Note**: This polling mechanism mirrors the "Animated Lower Thirds" pattern to bypass OBS sandbox restrictions between Lua and Browser sources.

## Guidelines for AI Assistant (v2.0)

### Code Style
- **JS**: Pure ES5 syntax for maximum compatibility with OBS CEF browser (Chromium 75-103).
  - Use `var` instead of `const`/`let`.
  - Use `function` instead of arrow functions (`=>`).
  - Use `for` loops instead of `.map()`, `.forEach()`, etc. when possible.
  - No ES6 modules (`import`/`export`)—everything is in one `<script>` tag per file.
  - No `async`/`await`—use callbacks or Promises with `.then()`.
- **CSS**: Use CSS Variables (`var(--name)`). Inline all styles within `<style>` tags—no external `.css` files.
- **Lua**: Follow standard Lua 5.1/JIT syntax compatible with OBS. Use `script_path()` for reliable path detection.

### Critical Files
- **`hotkeys.js`**: **DO NOT EDIT MANUALLY**. This is a transient file generated by the Lua script and polled by the Dock.
  - Format: `window.__obsTextSlidesHotkey = { seq: <number>, command: <string|number> };`
- **`slides.json`**: **USER DATA**. Auto-generated fallback storage. Do not assume its content is static.
- **`Dock.html` and `Source.html`**: Fully bundled—all CSS, JS, and markdown rendering is inline. Do NOT split them into separate files.

### Common Tasks
- **Adding Animations**: 
  - Edit the `<style>` section in `Source.html`, add new `@keyframes` rules.
  - Update `swapContent()` function to handle the new transition type.
- **Adding Hotkeys**: 
  1. Update `obs-text-slides.lua` to register the new hotkey and write the command to `hotkeys.js`.
  2. Update `pollLuaCommands()` function in `Dock.html` to handle the new command.
- **Changing Typography**:
  - Dock: Update UI controls in the HTML and `updateSettings()` function.
  - Source: Update `applyTypography()` function to apply the new style.

### Debugging
- **Hotkeys not working**: 
  - Check if `hotkeys.js` is being updated on disk (open it in a text editor after pressing a hotkey).
  - Check if Dock is polling (open browser console in the Dock, look for script injection logs).
  - Verify Lua script is loaded in OBS (Tools > Scripts).
- **Slides not syncing**: 
  - Check `BroadcastChannel` support (open browser console, type `typeof BroadcastChannel`—should be `"function"`).
  - If fallback mode, check if `slides.json` exists and is being updated.
  - Check browser console for errors in both Dock and Source.
- **Source not displaying**: 
  - Verify Browser Source path is correct (absolute path with `file:///` prefix).
  - Check Browser Source size matches canvas (e.g., 1920x1080).
  - Check if Source is receiving state (open browser console, look for "state: ready" in debug mode).

### Performance Considerations (v2.0)
- **Debouncing**: Typography inputs use 300ms debounce to avoid excessive state updates.
- **Caching**: Markdown rendering is cached (max 100 entries) to avoid re-parsing.
- **GPU Acceleration**: All animations use `transform: translateZ(0)` for hardware acceleration.
- **Lazy Loading**: Google Fonts are loaded dynamically only when first used.
- **Memory Management**: Status log is limited to 50 entries to prevent memory leaks.

## Release Process (v2.0+)

### Making a Release via Chat/AI Assistant

**Method**: GitHub CLI (`gh`) - Direct release creation via chat

**When user asks for a release (e.g., "criar release versão 2.1" or "create release version 2.1.0"):**

1. **Verify/Update CHANGELOG.md**: Check if entry exists for the version. If not, create it with:
   - Date in format `YYYY-MM-DD` (use current date - check system date, not assume)
   - Sections: Added, Changed, Fixed, Removed (as applicable)
   - **MUST end with `---` separator** (three dashes on blank line) to prevent workflow from including previous versions
   - Follow existing format and style exactly
   - Example structure:
     ```markdown
     ## [X.Y.Z] - YYYY-MM-DD
     
     ### Added
     - Feature description
     
     ### Fixed
     - Bug fix description
     
     ---
     ```

2. **Commit CHANGELOG**: Stage and commit the CHANGELOG update with message like `chore: prepare release X.Y.Z`

3. **Push to main**: Ensure all changes are pushed to `origin/main`

4. **Authenticate GitHub CLI** (if not already authenticated):
   ```bash
   gh auth login
   ```
   Follow the interactive prompts to authenticate.

5. **Create release via GitHub CLI** (preferred method - uses workflow to create ZIP):
   ```bash
   gh workflow run release.yml -f version=X.Y.Z
   ```
   This triggers the GitHub Actions workflow which will:
   - Create the release package ZIP automatically
   - Extract notes from CHANGELOG.md
   - Create Git tag and GitHub Release

   **Alternative method** (if workflow dispatch fails):
   ```bash
   gh release create vX.Y.Z --title "Release X.Y.Z" --notes-file release-notes-X.Y.Z.txt
   ```
   Note: This method requires manual ZIP creation, so prefer the workflow method.

5. **Monitor workflow**: The workflow will:
   - Validate version format
   - Check if tag exists
   - Create ZIP package
   - Extract notes from CHANGELOG
   - Create Git tag
   - Create GitHub Release

**Alternative (if GitHub CLI workflow dispatch fails):**
- Use `gh release create` directly with notes extracted from CHANGELOG.md

**What the workflow does:**
- Validates version format (must be X.Y.Z)
- Checks if tag already exists
- Creates release package ZIP (`htmlTextSlideshow-X.Y.Z.zip`) with files directly in root:
  - `Dock.html`
  - `Source.html`
  - `text-slides.lua`
  - `README.md`
  - `LICENSE`
- **Important**: ZIP contains files in root (no `release-package/` folder) for easy extraction
- Extracts release notes from CHANGELOG.md (if not provided manually)
- Creates Git tag
- Creates GitHub Release with ZIP attachment

**Version Numbering:**
- Follow semantic versioning: `MAJOR.MINOR.PATCH`
- **MAJOR**: Breaking changes (e.g., 2.0.0 → 3.0.0)
- **MINOR**: New features, backwards compatible (e.g., 2.0.0 → 2.1.0)
- **PATCH**: Bug fixes, backwards compatible (e.g., 2.0.0 → 2.0.1)

**CHANGELOG Format (CRITICAL - Must follow exactly):**
```markdown
## [X.Y.Z] - YYYY-MM-DD

### Added
- New feature description

### Changed
- Change description

### Fixed
- Bug fix description

### Removed
- Removed feature description

---
```

**CRITICAL CHANGELOG Rules:**
- **ALWAYS** end the version section with `---` separator (three dashes on a blank line)
- **NEVER** include content from previous versions in the extracted notes
- **ALWAYS** use proper markdown formatting (headers, lists, bold)
- **ALWAYS** use current date in format `YYYY-MM-DD` (e.g., `2025-12-07`)
- The workflow extracts from `## [VERSION]` until `---` or next `## [VERSION]`
- Without the `---` separator, the workflow may include content from previous versions

**Important Notes:**
- The workflow does NOT automatically update version numbers in code files (like `Dock.html`).
- Version in `Dock.html` (line ~1260) is for internal state tracking, not release version.
- Always update CHANGELOG.md before creating a release.
- The ZIP file is named: `htmlTextSlideshow-X.Y.Z.zip`
- The ZIP contains files directly in root (no intermediate folder like `release-package/`)
- Users extract the ZIP and get the files ready to use (no nested folders)
- The workflow preserves markdown formatting when extracting notes from CHANGELOG.md
