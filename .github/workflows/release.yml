name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.1.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (optional, will use CHANGELOG if empty)'
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine Version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Triggered by tag, strip refs/tags/v or refs/tags/
            REF_NAME="${{ github.ref_name }}"
            # Remove 'v' prefix if present for consistency with X.Y.Z format
            VERSION="${REF_NAME#v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Detected version: $VERSION"

      - name: Validate version format
        run: |
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 2.1.0). Got: $VERSION"
            exit 1
          fi
          echo "Version validated: $VERSION"
      
      - name: Check if tag exists (Manual only)
        if: github.event_name == 'workflow_dispatch'
        id: check_tag
        run: |
          TAG_NAME="v$VERSION"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME already exists!"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME is available"
          fi
      
      - name: Create release package
        run: |
          # Create ZIP file with files directly in root (no intermediate folder)
          PKG_NAME="htmlTextSlideshow-${VERSION}.zip"
          zip "$PKG_NAME" \
            Dock.html \
            Source.html \
            text-slides.lua \
            README.md \
            LICENSE
          # List contents for verification
          echo "ðŸ“¦ Release package contents:"
          unzip -l "$PKG_NAME"
          echo "âœ… Created ZIP: $PKG_NAME"
          # ls -lh "$PKG_NAME"
      
      - name: Extract release notes from CHANGELOG
        id: changelog
        if: inputs.release_notes == ''
        run: |
          # Extract the version entry from CHANGELOG.md
          # Search for [2.2.0] or [v2.2.0]
          
          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
            awk -v version="$VERSION" '
              BEGIN { in_section = 0; found = 0 }
              /^## \[/ && found == 1 { exit }
              /^## \[/ && $0 ~ "\\[" version "\\]" { in_section = 1; found = 1; next }
              /^---$/ && in_section == 1 { exit }
              in_section == 1 { print }
            ' CHANGELOG.md > /tmp/release_notes.txt
          else
            echo "âš ï¸  Warning: Version $VERSION not found in CHANGELOG.md"
            echo "Release $VERSION" > /tmp/release_notes.txt
          fi
          
          # Output notes using GitHub Actions multiline format (preserves markdown)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Git tag (Manual only)
        if: github.event_name == 'workflow_dispatch' && steps.check_tag.outputs.exists == 'false'
        run: |
          TAG_NAME="v$VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release $VERSION"
          git push origin "$TAG_NAME"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "Release v${{ env.VERSION }}"
          body: |
            ${{ inputs.release_notes != '' && inputs.release_notes || steps.changelog.outputs.notes }}
            
            ## ðŸ“¦ Download
            
            Download the ZIP file below and extract it to use the slideshow in OBS Studio.
          files: htmlTextSlideshow-${{ env.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

