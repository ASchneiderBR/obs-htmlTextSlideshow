<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OBS Text Slides Dock</title>
    <style>
:root {
  color-scheme: dark;
  --bg: #0d1117;
  --panel: #161b22;
  --border: #30363d;
  --text: #c9d1d9;
  --muted: #8b949e;
  --accent: #2f81f7;
  --radius: 12px;
  --font-sans: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: var(--font-sans);
  font-size: 14px;
  background: var(--bg);
  color: var(--text);
}

.app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 12px;
}

.app__header,
.app__footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--panel);
  padding: 14px 18px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  gap: 12px;
}

.target__path {
  background: #0b1320;
  padding: 2px 6px;
  border-radius: 4px;
  border: 1px solid var(--border);
  font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Consolas, monospace;
  font-size: 0.75rem;
}

.ghost {
  background: transparent;
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 12px;
  cursor: pointer;
  font-size: 0.85rem;
  white-space: nowrap;
}

.app__main {
  display: grid;
  grid-template-columns: 240px 1fr 1fr;
  gap: 12px;
}

.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  min-height: 160px;
  display: flex;
  flex-direction: column;
}

.panel--status:not([open]) {
  min-height: auto;
}

.panel--sidebar {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.panel--sidebar h2 {
  margin: 0 0 8px 0;
  padding: 0;
  font-size: 0.9rem;
  color: var(--text);
}

.panel--settings {
  display: flex;
  flex-direction: column;
  gap: 8px;
  position: relative;
}

.panel--settings label {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.8rem;
  margin-bottom: 0;
  color: var(--text);
}

.panel--settings select,
.panel--settings input[type="number"] {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: #0b1320;
  color: var(--text);
  font-family: var(--font-sans);
  font-size: 0.85rem;
  cursor: pointer;
}

.panel--settings input[type="number"] {
  cursor: text;
}

.panel--settings input[type="range"] {
  cursor: pointer;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  appearance: none;
  -webkit-appearance: none;
  margin: 0;
}

.panel--settings input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--text);
  border: 2px solid var(--bg);
  cursor: pointer;
  box-shadow: 0 0 0 1px var(--border);
}

.label-with-inline-trigger {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.8rem;
  margin-bottom: 0;
  color: var(--text);
}

.label-text {
  display: block;
  margin-bottom: 0;
}

.input-with-trigger {
  display: flex;
  gap: 6px;
  align-items: center;
}

.input-with-trigger select {
  flex: 1;
  min-width: 0;
}

.color-trigger-btn-inline {
  width: 34px;
  height: 34px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #0b1320;
  cursor: pointer;
  padding: 3px;
  transition: all 0.2s;
  flex-shrink: 0;
}

.color-trigger-btn-inline:hover {
  border-color: var(--accent);
}

.color-trigger-swatch {
  display: block;
  width: 100%;
  height: 100%;
  border-radius: 3px;
  background-color: var(--swatch-color, #ffffff);
  opacity: var(--swatch-opacity, 1);
}

.color-picker-popover {
  position: absolute;
  z-index: 1000;
  background: rgba(22, 27, 34, 0.95);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  min-width: 220px;
  left: 50%;
  transform: translateX(-50%);
  backdrop-filter: blur(8px);
}

.color-picker-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(2px);
  z-index: 999;
}

.panel--sidebar {
  position: relative;
  overflow: visible;
}

.color-picker-content {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.color-picker-row {
  display: flex;
  gap: 8px;
  align-items: center;
}

.color-picker-row input[type="text"] {
  flex: 1;
  font-family: "JetBrains Mono", monospace;
  text-transform: uppercase;
  padding: 6px 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: #0b1320;
  color: var(--text);
  font-size: 0.85rem;
}

.color-picker-row input[type="color"] {
  width: 40px;
  height: 32px;
  padding: 2px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: transparent;
  cursor: pointer;
}

.color-picker-opacity {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.color-picker-opacity label {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.75rem;
  color: var(--muted);
}

.color-picker-opacity label > span:first-child {
  font-weight: 500;
}

.color-picker-opacity input[type="range"] {
  width: 100%;
}

.color-picker-opacity label > span:last-child {
  text-align: right;
  font-family: "JetBrains Mono", monospace;
  color: var(--text);
}

.panel--settings select:focus,
.panel--settings input[type="number"]:focus {
  outline: none;
  border-color: var(--accent);
}

.panel__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.panel--status {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0;
  min-height: auto;
}

.panel--status[open] {
  min-height: 150px;
}

.panel--status summary {
  list-style: none;
  cursor: pointer;
  padding: 0;
}

.panel--status summary::-webkit-details-marker {
  display: none;
}

.status__body {
  padding: 0 12px 12px 12px;
  margin-top: 12px;
  display: none;
}

.panel--status[open] .status__body {
  display: block;
}

.status__summary {
  list-style: none;
  cursor: pointer;
  padding: 0;
  user-select: none;
  transition: background 0.2s ease;
  display: block;
}

.status__summary .panel__header {
  padding: 12px;
  padding-bottom: 0;
}

.panel--status:not([open]) .status__summary .panel__header {
  padding-bottom: 12px;
}

.status__summary:hover {
  background: rgba(255, 255, 255, 0.03);
}

.status__meta {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.8rem;
  margin-bottom: 8px;
}

.toolbar {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.toolbar button {
  border: 1px solid var(--border);
  background: #0b1320;
  color: var(--text);
  border-radius: 6px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 0.75rem;
}

.panel h2 {
  margin: 0;
  font-size: 0.9rem;
  color: var(--text);
}

textarea {
  width: 100%;
  min-height: 240px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: #0b1320;
  color: var(--text);
  font-family: var(--font-sans);
  padding: 10px;
  resize: vertical;
  font-size: 0.9rem;
  line-height: 1.4;
  margin-top: 12px;
}

.markdown-help {
  margin-top: 8px;
  margin-bottom: 8px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: rgba(47, 129, 247, 0.05);
  overflow: hidden;
}

.markdown-help summary {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 0.8rem;
  color: var(--text);
  user-select: none;
  list-style: none;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background 0.2s ease;
}

.markdown-help summary::-webkit-details-marker {
  display: none;
}

.markdown-help summary:hover {
  background: rgba(47, 129, 247, 0.1);
}

.markdown-help[open] summary {
  border-bottom: 1px solid var(--border);
  background: rgba(47, 129, 247, 0.08);
}

.markdown-help__list {
  list-style: none;
  padding: 10px 12px;
  margin: 0;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 6px;
  font-size: 0.75rem;
}

.markdown-help__list li {
  color: var(--text);
  padding: 4px 0;
}

.markdown-help__list code {
  background: #0b1320;
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 0.7rem;
  color: var(--accent);
  font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Consolas, monospace;
}

.btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #0b1320;
  color: var(--text);
  font-family: var(--font-sans);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 500;
}

.btn:hover:not(:disabled) {
  background: #1a2332;
  border-color: var(--accent);
}

.btn--primary {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
  margin-top: 8px;
  width: 100%;
}

.btn--primary:hover:not(:disabled) {
  background: #4a91ff;
  border-color: #4a91ff;
}

.btn--danger {
  background: #f85149;
  border-color: #f85149;
  color: #fff;
}

.btn--danger:hover:not(:disabled) {
  background: #ff6b63;
  border-color: #ff6b63;
}

.btn--info {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

.btn--info:hover:not(:disabled) {
  background: #4a91ff;
  border-color: #4a91ff;
}

.btn--small {
  padding: 4px 10px;
  font-size: 0.75rem;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.muted {
  color: var(--muted);
  font-size: 0.85rem;
}

.panel--preview {
  overflow: hidden;
  max-height: 600px;
}

.panel__header--sticky {
  position: sticky;
  top: 0;
  background: var(--panel);
  z-index: 10;
  margin: -12px -12px 0 -12px;
  padding: 12px;
  margin-bottom: 12px;
}

.preview__slides {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0 0 12px 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 200px;
}

.preview__slides::-webkit-scrollbar {
  width: 12px;
}

.preview__slides::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 6px;
  margin: 4px 0;
}

.preview__slides::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 6px;
  border: 2px solid var(--panel);
}

.preview__slides::-webkit-scrollbar-thumb:hover {
  background: #4a91ff;
}

.preview__slides::-webkit-scrollbar-thumb:active {
  background: #2f81f7;
}

.preview__empty {
  color: var(--muted);
  font-style: italic;
  text-align: center;
  padding: 40px 15px;
  font-size: 0.85rem;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.preview__actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.preview__slide {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  background: rgba(255, 255, 255, 0.02);
  cursor: move;
  transition: all 0.2s ease;
  position: relative;
  font-size: 0.85rem;
  flex-shrink: 0;
}

.preview__slide:hover {
  background: rgba(255, 255, 255, 0.04);
  border-color: var(--accent);
}

.preview__slide--active {
  border-color: var(--accent);
  background: rgba(47, 129, 247, 0.08);
  box-shadow: 0 0 0 2px rgba(47, 129, 247, 0.2);
}

.preview__slide.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

.preview__slide.drag-over {
  border-color: var(--accent);
  background: rgba(47, 129, 247, 0.1);
}

.preview__slide-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
  padding-bottom: 6px;
  border-bottom: 1px dashed var(--border);
}

.preview__slide-title {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}

.preview__slide-drag-handle {
  cursor: grab;
  color: var(--muted);
  font-size: 1rem;
  user-select: none;
}

.preview__slide-actions {
  display: flex;
  gap: 4px;
}

.preview__slide-play {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--muted);
  padding: 3px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.7rem;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 28px;
}

.preview__slide-play:hover {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

.preview__slide--active .preview__slide-play {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

.preview__slide-delete {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--muted);
  padding: 3px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.7rem;
  transition: all 0.2s ease;
}

.preview__slide-delete:hover {
  background: #f85149;
  border-color: #f85149;
  color: #fff;
}

.preview__slide-content {
  color: var(--text);
  font-size: 0.85rem;
  line-height: 1.4;
}

.preview__slide-content h1,
.preview__slide-content h2,
.preview__slide-content h3 {
  font-size: 1em;
  margin: 0.3em 0;
}

.preview__slide-content p {
  margin: 0.3em 0;
}

.preview__slide-content ul,
.preview__slide-content ol {
  margin: 0.3em 0;
  padding-left: 1.5em;
  display: inline-block;
  text-align: left;
  max-width: 100%;
}

.list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.list li {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 0.8rem;
  background: rgba(255, 255, 255, 0.02);
}

.list--log li {
  font-size: 0.75rem;
  border-style: dashed;
  font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Consolas, monospace;
}

.panel--log {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
}

.tag {
  font-size: 0.65rem;
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 2px 8px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--muted);
}

.pill {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 0.7rem;
}

.preview__count {
  font-size: 0.8rem;
  color: var(--muted);
}

.pill--neutral {
  background: #30363d;
  color: var(--muted);
}

.pill--success {
  background: #238636;
  color: #fff;
}

.pill--danger {
  background: #f85149;
  color: #fff;
}

.pill--warning {
  background: #9e6a03;
  color: #fff;
}

.app__footer p {
  margin: 0;
  font-size: 0.9rem;
  color: var(--muted);
}

@media (max-width: 960px) {
  .app__main {
    grid-template-columns: 1fr;
  }
}
    </style>
  </head>
  <body>
    <div class="app" data-state="boot">
      <main class="app__main">
        <section class="panel panel--sidebar">
          <h2>Typography</h2>
          <div class="panel--settings">
            <label class="label-with-inline-trigger">
              <span class="label-text">Font</span>
              <div class="input-with-trigger">
                <select id="fontFamily">
                <optgroup label="Google Fonts - Sans Serif">
                  <option value="'Montserrat', sans-serif">Montserrat</option>
                  <option value="'Roboto', sans-serif">Roboto</option>
                  <option value="'Open Sans', sans-serif">Open Sans</option>
                  <option value="'Lato', sans-serif">Lato</option>
                  <option value="'Poppins', sans-serif">Poppins</option>
                  <option value="'Raleway', sans-serif">Raleway</option>
                  <option value="'Ubuntu', sans-serif">Ubuntu</option>
                  <option value="'Nunito', sans-serif">Nunito</option>
                  <option value="'PT Sans', sans-serif">PT Sans</option>
                  <option value="'Oswald', sans-serif">Oswald</option>
                </optgroup>
                <optgroup label="Google Fonts - Serif">
                  <option value="'Playfair Display', serif">Playfair Display</option>
                  <option value="'Merriweather', serif">Merriweather</option>
                </optgroup>
                <optgroup label="System Fonts - Sans Serif">
                  <option value="Inter, 'Segoe UI', sans-serif">Inter / System</option>
                  <option value="Arial, Helvetica, sans-serif">Arial</option>
                  <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
                  <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                  <option value="Verdana, Geneva, Tahoma, sans-serif">Verdana</option>
                  <option value="Tahoma, Verdana, Segoe, sans-serif">Tahoma</option>
                  <option value="'Trebuchet MS', 'Lucida Sans', Arial, sans-serif">Trebuchet MS</option>
                  <option value="Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif">Impact</option>
                </optgroup>
                <optgroup label="System Fonts - Serif">
                  <option value="Georgia, 'Times New Roman', Times, serif">Georgia</option>
                  <option value="'Times New Roman', Times, serif">Times New Roman</option>
                  <option value="Garamond, Baskerville, 'Times New Roman', serif">Garamond</option>
                  <option value="'Palatino Linotype', 'Book Antiqua', Palatino, serif">Palatino</option>
                </optgroup>
                <optgroup label="Monospace">
                  <option value="'JetBrains Mono', ui-monospace, SFMono-Regular, Consolas, monospace">JetBrains Mono</option>
                  <option value="'Courier New', Courier, monospace">Courier New</option>
                  <option value="Consolas, 'Courier New', monospace">Consolas</option>
                  <option value="'Lucida Console', Monaco, monospace">Lucida Console</option>
                </optgroup>
                <optgroup label="Display / Fun">
                  <option value="'Comic Sans MS', 'Comic Sans', cursive">Comic Sans MS</option>
                </optgroup>
              </select>
              <button type="button" class="color-trigger-btn-inline" id="colorTriggerBtn" title="Click to edit color">
                <span class="color-trigger-swatch"></span>
              </button>
              </div>
            </label>
            <label>
              Font size (px)
              <input id="fontSize" type="number" min="18" max="120" value="42" />
            </label>
            <label>
              Horizontal alignment
              <select id="textAlign">
                <option value="left">Left</option>
                <option value="center" selected>Center</option>
                <option value="right">Right</option>
              </select>
            </label>
            <label>
              Vertical alignment
              <select id="verticalAlign">
                <option value="flex-start">Top</option>
                <option value="center" selected>Middle</option>
                <option value="flex-end">Bottom</option>
              </select>
            </label>

            <label>
              Shadow intensity (0-100)
              <input id="shadowIntensity" type="number" min="0" max="100" value="0" />
            </label>
            <label>
              Stroke intensity (0-10)
              <input id="strokeIntensity" type="number" min="0" max="10" value="0" />
            </label>

            <!-- Color Picker Popover -->
            <div id="colorPickerBackdrop" class="color-picker-backdrop" hidden></div>
            <div id="colorPickerPopover" class="color-picker-popover" hidden>
              <div class="color-picker-content">
                <div class="color-picker-row">
                  <input id="textColorHex" type="text" value="#ffffff" maxlength="7" spellcheck="false" placeholder="#ffffff" />
                  <input id="textColor" type="color" value="#ffffff" />
                </div>
                <div class="color-picker-opacity">
                  <label>
                    <span>Opacity</span>
                    <input id="textOpacity" type="range" min="0" max="100" value="100" />
                    <span id="textOpacityValue">100%</span>
                  </label>
                </div>
              </div>
            </div>

          </div>
          <h2>Slide animation</h2>
          <div class="panel--settings">
            <label>
              Transition type
              <select id="transitionType">
                <option value="crossfade">Crossfade</option>
                <option value="fade">Fade (sequential)</option>
                <option value="slide-left">Slide left</option>
                <option value="slide-right">Slide right</option>
                <option value="slide-up">Slide up</option>
                <option value="slide-down">Slide down</option>
                <option value="zoom-in">Zoom in</option>
                <option value="zoom-out">Zoom out</option>
                <option value="push-left">Push left</option>
                <option value="push-right">Push right</option>
                <option value="push-up">Push up</option>
                <option value="push-down">Push down</option>
                <option value="none">None (instant)</option>
              </select>
            </label>
            <label>
              Duration (ms)
              <input id="transitionDuration" type="number" min="0" max="2000" step="50" value="200" />
            </label>
          </div>
        </section>
        <section class="panel panel--editor">
          <header class="panel__header">
            <h2>Text input</h2>
            <div class="toolbar">
              <button type="button" data-action="insert-delimiter">Insert ---</button>
            </div>
          </header>
          <textarea
            id="slidesTextarea"
            placeholder="Paste your text here. Use --- on a blank line to create multiple slides."
            spellcheck="false"
          ></textarea>
          <details class="markdown-help">
            <summary>ðŸ“– Markdown syntax supported</summary>
            <ul class="markdown-help__list">
              <li><code>**bold**</code> or <code>__bold__</code> â†’ <strong>bold</strong></li>
              <li><code>*italic*</code> or <code>_italic_</code> â†’ <em>italic</em></li>
              <li><code>~~strike~~</code> â†’ <del>strikethrough</del></li>
              <li><code># Heading</code> â†’ Headings (H1-H6)</li>
              <li><code>[text](url)</code> â†’ Links</li>
              <li><code>![alt](url)</code> â†’ Images</li>
              <li><code>- item</code> â†’ Unordered lists</li>
              <li><code>1. item</code> â†’ Ordered lists</li>
              <li><code>`code`</code> â†’ Inline code</li>
              <li><code>```code```</code> â†’ Code blocks</li>
              <li><code>&gt; quote</code> â†’ Blockquotes</li>
            </ul>
          </details>
          <button type="button" class="btn btn--primary" data-action="add-slides">Add slides</button>
        </section>
        <section class="panel panel--preview">
          <header class="panel__header panel__header--sticky">
            <h2>Slides preview</h2>
            <div class="preview__actions">
              <span class="preview__count" data-preview-count>0 slides</span>
              <button type="button" class="btn btn--small" data-action="toggle-loop" data-loop-enabled="true">Loop</button>
              <button type="button" class="btn btn--danger btn--small" data-action="clear-all" disabled>Clear</button>
            </div>
          </header>
          <div id="preview" class="preview__slides">
            <p class="preview__empty">No slides yet. Add content using the editor above.</p>
          </div>
        </section>
      </main>

      <details class="panel panel--status">
        <summary class="status__summary">
          <header class="panel__header">
            <h2>Status</h2>
            <span class="pill pill--success" data-status-pill>Booting</span>
          </header>
        </summary>
        <div class="status__body">
          <div class="status__meta">
            <span class="target__label">Storage</span>
            <code class="target__path">Local (per OBS instance)</code>
          </div>
          <ul id="statusLog" class="list list--log">
            <li>[Init] Waiting for editor inputâ€¦</li>
          </ul>
        </div>
      </details>
    </div>
    <script>
// Markdown renderer
const BLOCK_DELIMITER = "\n";

function escapeHtml(value) {
  return value
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function renderInline(value) {
  return value
    .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img alt="$1" src="$2" />')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
    .replace(/`([^`]+)`/g, "<code>$1</code>")
    .replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>")
    .replace(/__([^_]+)__/g, "<strong>$1</strong>")
    .replace(/\*([^*]+)\*/g, "<em>$1</em>")
    .replace(/_([^_]+)_/g, "<em>$1</em>")
    .replace(/~~([^~]+)~~/g, "<del>$1</del>");
}

function closeList(listState) {
  if (!listState.type) return "";
  const closing = listState.type === "ol" ? "</ol>" : "</ul>";
  listState.type = null;
  return closing;
}

function markdownToHtml(markdown) {
  if (!markdown) markdown = "";
  const lines = markdown.replace(/\r\n/g, BLOCK_DELIMITER).split(BLOCK_DELIMITER);
  let html = "";
  let inCodeBlock = false;
  let codeFence = "";
  let listState = { type: null };

  const flushParagraph = function(buffer) {
    if (!buffer.trim()) return;
    const lines = buffer.trim().split('\n');
    const processedLines = lines.map(function(line) { return renderInline(escapeHtml(line)); });
    html += "<p>" + processedLines.join('<br>') + "</p>";
  };

  let paragraphBuffer = "";
  let paragraphLines = [];

  for (let i = 0; i < lines.length; i++) {
    const rawLine = lines[i];
    const line = rawLine.replace(/\t/g, "    ");

    if (line.trim().startsWith("```")) {
      if (inCodeBlock) {
        html += "<pre><code>" + escapeHtml(codeFence) + "</code></pre>";
        codeFence = "";
        inCodeBlock = false;
      } else {
        if (paragraphLines.length > 0) {
          paragraphBuffer = paragraphLines.join('\n');
          flushParagraph(paragraphBuffer);
          paragraphBuffer = "";
          paragraphLines = [];
        }
        inCodeBlock = true;
      }
      continue;
    }

    if (inCodeBlock) {
      codeFence += (codeFence ? "\n" : "") + line;
      continue;
    }

    if (!line.trim()) {
      if (paragraphLines.length > 0) {
        paragraphBuffer = paragraphLines.join('\n');
        flushParagraph(paragraphBuffer);
        paragraphBuffer = "";
        paragraphLines = [];
      }
      html += closeList(listState);
      continue;
    }

    const headingMatch = line.match(/^(#{1,6})\s+(.*)$/);
    if (headingMatch) {
      if (paragraphLines.length > 0) {
        paragraphBuffer = paragraphLines.join('\n');
        flushParagraph(paragraphBuffer);
        paragraphBuffer = "";
        paragraphLines = [];
      }
      html += closeList(listState);
      const level = headingMatch[1].length;
      html += "<h" + level + ">" + renderInline(escapeHtml(headingMatch[2])) + "</h" + level + ">";
      continue;
    }

    const blockquoteMatch = line.match(/^>\s?(.*)$/);
    if (blockquoteMatch) {
      if (paragraphLines.length > 0) {
        paragraphBuffer = paragraphLines.join('\n');
        flushParagraph(paragraphBuffer);
        paragraphBuffer = "";
        paragraphLines = [];
      }
      html += closeList(listState);
      html += "<blockquote>" + renderInline(escapeHtml(blockquoteMatch[1])) + "</blockquote>";
      continue;
    }

    const unorderedMatch = line.match(/^[-*+]\s+(.*)$/);
    if (unorderedMatch) {
      if (paragraphLines.length > 0) {
        paragraphBuffer = paragraphLines.join('\n');
        flushParagraph(paragraphBuffer);
        paragraphBuffer = "";
        paragraphLines = [];
      }
      if (listState.type !== "ul") {
        html += closeList(listState);
        listState.type = "ul";
        html += "<ul>";
      }
      html += "<li>" + renderInline(escapeHtml(unorderedMatch[1])) + "</li>";
      continue;
    }

    const orderedMatch = line.match(/^\d+\.\s+(.*)$/);
    if (orderedMatch) {
      if (paragraphLines.length > 0) {
        paragraphBuffer = paragraphLines.join('\n');
        flushParagraph(paragraphBuffer);
        paragraphBuffer = "";
        paragraphLines = [];
      }
      if (listState.type !== "ol") {
        html += closeList(listState);
        listState.type = "ol";
        html += "<ol>";
      }
      html += "<li>" + renderInline(escapeHtml(orderedMatch[1])) + "</li>";
      continue;
    }

    paragraphLines.push(line.trim());
  }

  if (paragraphLines.length > 0) {
    paragraphBuffer = paragraphLines.join('\n');
    flushParagraph(paragraphBuffer);
  }

  html += closeList(listState);

  if (inCodeBlock) {
    html += "<pre><code>" + escapeHtml(codeFence) + "</code></pre>";
  }

  return html || "<p></p>";
}

// Main application
var textarea = document.querySelector("#slidesTextarea");
var preview = document.querySelector("#preview");
var insertDelimiterBtn = document.querySelector("[data-action='insert-delimiter']");
var addSlidesBtn = document.querySelector("[data-action='add-slides']");
var clearAllBtn = document.querySelector("[data-action='clear-all']");
var statusLogEl = document.querySelector("#statusLog");
var previewCountEl = document.querySelector("[data-preview-count]");

var fontSelect = document.querySelector("#fontFamily");
var fontSizeInput = document.querySelector("#fontSize");
var textAlignSelect = document.querySelector("#textAlign");
var verticalAlignSelect = document.querySelector("#verticalAlign");
var colorTriggerBtn = document.querySelector("#colorTriggerBtn");
var colorPickerPopover = document.querySelector("#colorPickerPopover");
var colorPickerBackdrop = document.querySelector("#colorPickerBackdrop");
var textColorInput = document.querySelector("#textColor");
var textColorHexInput = document.querySelector("#textColorHex");
var textOpacityInput = document.querySelector("#textOpacity");
var textOpacityValue = document.querySelector("#textOpacityValue");
var shadowIntensityInput = document.querySelector("#shadowIntensity");
var strokeIntensityInput = document.querySelector("#strokeIntensity");
var transitionTypeSelect = document.querySelector("#transitionType");
var transitionDurationInput = document.querySelector("#transitionDuration");
var loopBtn = document.querySelector("[data-action='toggle-loop']");
var statusPill = document.querySelector("[data-status-pill]");

var draggedSlideIndex = null;

var STATE_STORAGE_KEY = "obsTextSlides.state";
var DELIMITER = "\n\n---\n\n";

var clone = function(value) { return JSON.parse(JSON.stringify(value)); };

function debounce(func, wait) {
  var timeout;
  return function executedFunction() {
    var args = Array.prototype.slice.call(arguments);
    var later = function() {
      clearTimeout(timeout);
      func.apply(null, args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

var markdownCache = {};
var cacheKeys = [];
var MAX_CACHE_SIZE = 100;

function cachedMarkdownToHtml(markdown) {
  if (markdownCache[markdown]) {
    return markdownCache[markdown];
  }
  
  var html = markdownToHtml(markdown);
  
  if (cacheKeys.length >= MAX_CACHE_SIZE) {
    var firstKey = cacheKeys.shift();
    delete markdownCache[firstKey];
  }
  
  markdownCache[markdown] = html;
  cacheKeys.push(markdown);
  return html;
}

var DEFAULT_STATE = {
  version: "1.0.0",
  updatedAt: new Date().toISOString(),
  metadata: {
    lastWriter: "dock-ui",
    source: "control-panel",
    notes: "initial",
  },
  settings: {
    defaultFontFamily: "'Montserrat', sans-serif",
    defaultFontSizePx: 42,
    lineHeight: 1.25,
    textAlign: "center",
    verticalAlign: "center",
    textColor: "#ffffff",
    textOpacity: 100,
    shadowIntensity: 0,
    strokeIntensity: 0,
    markdown: true,
    transitionType: "crossfade",
    transitionDuration: 200,
  },
  slides: [
    {
      id: "slide-001",
      title: "Welcome",
      body: "### Hello!\nUse `---` on a blank line to create the next slide.",
      raw: "Welcome\n\n### Hello!\nUse `---` on a blank line to create the next slide.",
      fontFamily: null,
      fontSizePx: null,
      textAlign: null,
      notes: "",
      durationMs: 0,
    },
    {
      id: "slide-002",
      title: "Demo",
      body: "- Edit everything inside the dock\n- Auto-sync pushes changes every second",
      raw: "Demo\n\n- Edit everything inside the dock\n- Auto-sync pushes changes every second",
      fontFamily: null,
      fontSizePx: null,
      textAlign: null,
      notes: "",
      durationMs: 0,
    },
  ],
  activeSlideIndex: 0,
  playlist: {
    mode: "manual",
    loop: true,
    autoAdvanceMs: 0,
  },
};

var state = loadStateFromStorage();
var luaSeq = 0;

var channel = new BroadcastChannel("obs-text-slides");
channel.addEventListener("message", function(event) {
  var payload = event && event.data;
  if (!payload || typeof payload !== "object") return;
  if (payload.type === "request-state") {
    channel.postMessage({ type: "state", source: "dock-ui", payload: state });
    appendStatusLog("Shared current state with overlay.");
  }
});

function loadStateFromStorage() {
  try {
    var raw = localStorage.getItem(STATE_STORAGE_KEY);
    if (!raw) return clone(DEFAULT_STATE);
    var parsed = JSON.parse(raw);
    if (!Array.isArray(parsed.slides)) {
      return clone(DEFAULT_STATE);
    }
    var merged = clone(DEFAULT_STATE);
    for (var key in parsed) {
      if (parsed.hasOwnProperty(key)) {
        merged[key] = parsed[key];
      }
    }
    if (parsed.settings) {
      for (var skey in parsed.settings) {
        if (parsed.settings.hasOwnProperty(skey)) {
          merged.settings[skey] = parsed.settings[skey];
        }
      }
    }
    return merged;
  } catch (e) {
    return clone(DEFAULT_STATE);
  }
}

function persistState(reason) {
  if (!reason) reason = "auto";
  state.updatedAt = new Date().toISOString();
  state.metadata = {
    lastWriter: "dock-ui",
    source: "control-panel",
    notes: reason,
  };
  localStorage.setItem(STATE_STORAGE_KEY, JSON.stringify(state));
  channel.postMessage({ type: "state", source: "dock-ui", payload: state });
  renderStatus("Auto-sync ready", "success");
  appendStatusLog("Saved " + state.slides.length + " slides (" + reason + ").");
}

function applyStateToUi() {
  if (fontSelect) fontSelect.value = state.settings.defaultFontFamily;
  if (fontSizeInput) fontSizeInput.value = String(state.settings.defaultFontSizePx);
  if (textAlignSelect) textAlignSelect.value = state.settings.textAlign;
  if (verticalAlignSelect) verticalAlignSelect.value = state.settings.verticalAlign;
  if (textColorInput) textColorInput.value = state.settings.textColor || "#ffffff";
  if (textColorHexInput) textColorHexInput.value = state.settings.textColor || "#ffffff";
  if (textOpacityInput) {
    textOpacityInput.value = String(state.settings.textOpacity != null ? state.settings.textOpacity : 100);
    if (textOpacityValue) textOpacityValue.textContent = textOpacityInput.value + "%";
  }
  updateColorSwatch();
  if (shadowIntensityInput) shadowIntensityInput.value = String(state.settings.shadowIntensity != null ? state.settings.shadowIntensity : 0);
  if (strokeIntensityInput) strokeIntensityInput.value = String(state.settings.strokeIntensity != null ? state.settings.strokeIntensity : 0);
  if (transitionTypeSelect) transitionTypeSelect.value = state.settings.transitionType || "crossfade";
  if (transitionDurationInput) transitionDurationInput.value = String(state.settings.transitionDuration || 200);
  updateLoopButton();
  renderPreview();
  updateClearAllButton();
}

function renderPreview() {
  if (!preview) return;
  
  if (!state.slides || state.slides.length === 0) {
    preview.innerHTML = '<p class="preview__empty">No slides yet. Add content using the editor above.</p>';
    if (previewCountEl) {
      previewCountEl.textContent = "0 slides";
    }
    return;
  }

  var scrollTop = preview.scrollTop;
  
  var html = "";
  for (var i = 0; i < state.slides.length; i++) {
    var slide = state.slides[i];
    var isActive = i === state.activeSlideIndex;
    html += '<article class="preview__slide' + (isActive ? ' preview__slide--active' : '') + '" draggable="true" data-slide-index="' + i + '">';
    html += '<div class="preview__slide-header">';
    html += '<div class="preview__slide-title">';
    html += '<span class="preview__slide-drag-handle">â˜°â˜°</span>';
    html += '<span>Slide ' + (i + 1) + '</span>';
    html += '</div>';
    html += '<div class="preview__slide-actions">';
    html += '<button type="button" class="preview__slide-play" data-play-index="' + i + '" title="Show this slide">â–¶</button>';
    html += '<button type="button" class="preview__slide-delete" data-delete-index="' + i + '" title="Delete this slide">Delete</button>';
    html += '</div>';
    html += '</div>';
    html += '<div class="preview__slide-content">' + cachedMarkdownToHtml(slide.raw || "") + '</div>';
    html += '</article>';
  }
  
  preview.innerHTML = html;
  preview.scrollTop = scrollTop;
  
  if (previewCountEl) {
    previewCountEl.textContent = state.slides.length + " " + (state.slides.length === 1 ? "slide" : "slides");
  }

  attachSlideEventListeners();
}

function parseSlides(value) {
  var chunks = value ? value.split(/\n\s*---\s*\n/g) : [];
  var results = [];
  for (var i = 0; i < chunks.length; i++) {
    var chunk = chunks[i].trim();
    if (!chunk) continue;
    var lines = chunk.split("\n");
    results.push({
      id: "slide-" + String(i + 1).padStart(10, "0"),
      title: lines[0] || "Slide " + (i + 1),
      body: chunk,
      raw: chunk,
      fontFamily: null,
      fontSizePx: null,
      textAlign: null,
      notes: "",
      durationMs: 0,
    });
  }
  return results;
}

function addSlides() {
  if (!textarea || !textarea.value.trim()) return;
  
  var newSlides = parseSlides(textarea.value);
  if (!newSlides.length) return;
  
  state.slides = state.slides.concat(newSlides);
  textarea.value = "";
  
  renderPreview();
  updateClearAllButton();
  persistState("add-slides");
  appendStatusLog("Added " + newSlides.length + " slide" + (newSlides.length > 1 ? 's' : '') + ".");
}

function deleteSlide(index) {
  if (index < 0 || index >= state.slides.length) return;
  
  state.slides.splice(index, 1);
  
  if (state.activeSlideIndex >= state.slides.length) {
    state.activeSlideIndex = Math.max(0, state.slides.length - 1);
  }
  
  renderPreview();
  updateClearAllButton();
  persistState("delete-slide");
  appendStatusLog("Deleted slide " + (index + 1) + ".");
}

function clearAllSlides() {
  if (!state.slides.length) return;
  
  var count = state.slides.length;
  state.slides = [];
  state.activeSlideIndex = 0;
  
  renderPreview();
  updateClearAllButton();
  persistState("clear-all");
  appendStatusLog("Cleared all " + count + " slides.");
}

function updateClearAllButton() {
  if (!clearAllBtn) return;
  clearAllBtn.disabled = !state.slides || state.slides.length === 0;
}

function insertDelimiter() {
  if (!textarea) return;
  var selectionStart = textarea.selectionStart;
  var selectionEnd = textarea.selectionEnd;
  var value = textarea.value;
  textarea.value = value.slice(0, selectionStart) + DELIMITER + value.slice(selectionEnd);
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = selectionStart + DELIMITER.length;
}

function attachSlideEventListeners() {
  var playButtons = document.querySelectorAll(".preview__slide-play");
  for (var i = 0; i < playButtons.length; i++) {
    playButtons[i].addEventListener("click", function(e) {
      e.stopPropagation();
      var index = parseInt(this.dataset.playIndex, 10);
      setActiveSlide(index, "manual-play");
    });
  }

  var deleteButtons = document.querySelectorAll(".preview__slide-delete");
  for (var i = 0; i < deleteButtons.length; i++) {
    deleteButtons[i].addEventListener("click", function(e) {
      e.stopPropagation();
      var index = parseInt(this.dataset.deleteIndex, 10);
      deleteSlide(index);
    });
  }

  var slides = document.querySelectorAll(".preview__slide");
  for (var i = 0; i < slides.length; i++) {
    slides[i].addEventListener("dragstart", handleDragStart);
    slides[i].addEventListener("dragover", handleDragOver);
    slides[i].addEventListener("drop", handleDrop);
    slides[i].addEventListener("dragend", handleDragEnd);
    slides[i].addEventListener("dragenter", handleDragEnter);
    slides[i].addEventListener("dragleave", handleDragLeave);
  }
}

function handleDragStart(e) {
  draggedSlideIndex = parseInt(e.currentTarget.dataset.slideIndex, 10);
  e.currentTarget.classList.add("dragging");
  e.dataTransfer.effectAllowed = "move";
  e.dataTransfer.setData("text/html", e.currentTarget.innerHTML);
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = "move";
  return false;
}

function handleDragEnter(e) {
  e.currentTarget.classList.add("drag-over");
}

function handleDragLeave(e) {
  e.currentTarget.classList.remove("drag-over");
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  e.preventDefault();

  var dropIndex = parseInt(e.currentTarget.dataset.slideIndex, 10);
  
  if (draggedSlideIndex !== null && draggedSlideIndex !== dropIndex) {
    var draggedSlide = state.slides[draggedSlideIndex];
    state.slides.splice(draggedSlideIndex, 1);
    state.slides.splice(dropIndex, 0, draggedSlide);
    
    if (state.activeSlideIndex === draggedSlideIndex) {
      state.activeSlideIndex = dropIndex;
    } else if (draggedSlideIndex < state.activeSlideIndex && dropIndex >= state.activeSlideIndex) {
      state.activeSlideIndex--;
    } else if (draggedSlideIndex > state.activeSlideIndex && dropIndex <= state.activeSlideIndex) {
      state.activeSlideIndex++;
    }
    
    renderPreview();
    persistState("reorder-slides");
    appendStatusLog("Moved slide " + (draggedSlideIndex + 1) + " to position " + (dropIndex + 1) + ".");
  }

  return false;
}

function handleDragEnd(e) {
  e.currentTarget.classList.remove("dragging");
  var allSlides = document.querySelectorAll(".preview__slide");
  for (var i = 0; i < allSlides.length; i++) {
    allSlides[i].classList.remove("drag-over");
  }
  draggedSlideIndex = null;
}

function updateSettings(reason) {
  if (!reason) reason = "settings";
  state.settings.defaultFontFamily = fontSelect ? fontSelect.value : state.settings.defaultFontFamily;
  state.settings.defaultFontSizePx = fontSizeInput ? Number(fontSizeInput.value) : state.settings.defaultFontSizePx;
  state.settings.textAlign = textAlignSelect ? textAlignSelect.value : state.settings.textAlign;
  state.settings.verticalAlign = verticalAlignSelect ? verticalAlignSelect.value : state.settings.verticalAlign;
  state.settings.textColor = textColorInput ? textColorInput.value : state.settings.textColor;
  state.settings.textOpacity = textOpacityInput ? Number(textOpacityInput.value) : state.settings.textOpacity;

  if (textColorHexInput && textColorInput) textColorHexInput.value = textColorInput.value;
  if (textOpacityValue && textOpacityInput) textOpacityValue.textContent = textOpacityInput.value + "%";
  updateColorSwatch();

  state.settings.shadowIntensity = shadowIntensityInput ? Number(shadowIntensityInput.value) : state.settings.shadowIntensity;
  state.settings.strokeIntensity = strokeIntensityInput ? Number(strokeIntensityInput.value) : state.settings.strokeIntensity;
  state.settings.transitionType = transitionTypeSelect ? transitionTypeSelect.value : state.settings.transitionType;
  state.settings.transitionDuration = transitionDurationInput ? Number(transitionDurationInput.value) : state.settings.transitionDuration;
  persistState(reason);
}

function updateColorSwatch() {
  var swatch = document.querySelector(".color-trigger-swatch");
  if (!swatch) return;
  var color = textColorInput ? textColorInput.value : "#ffffff";
  var opacity = textOpacityInput ? Number(textOpacityInput.value) / 100 : 1;
  swatch.style.setProperty("--swatch-color", color);
  swatch.style.setProperty("--swatch-opacity", String(opacity));
}

function showColorPicker() {
  if (!colorPickerPopover || !colorTriggerBtn) return;
  
  var settings = document.querySelector(".panel--settings");
  var btnRect = colorTriggerBtn.getBoundingClientRect();
  var settingsRect = settings.getBoundingClientRect();
  
  var top = btnRect.top - settingsRect.top + btnRect.height + 4;
  
  colorPickerPopover.style.top = top + "px";
  colorPickerPopover.hidden = false;
  if (colorPickerBackdrop) colorPickerBackdrop.hidden = false;
}

function hideColorPicker() {
  if (colorPickerPopover) colorPickerPopover.hidden = true;
  if (colorPickerBackdrop) colorPickerBackdrop.hidden = true;
}

function toggleLoop() {
  if (!state.playlist) state.playlist = { mode: "manual", loop: true, autoAdvanceMs: 0 };
  state.playlist.loop = !state.playlist.loop;
  updateLoopButton();
  persistState("loop setting");
  appendStatusLog("Loop " + (state.playlist.loop ? 'enabled' : 'disabled') + ".");
}

function updateLoopButton() {
  if (!loopBtn) return;
  var isLoopEnabled = state.playlist && state.playlist.loop != null ? state.playlist.loop : true;
  loopBtn.dataset.loopEnabled = String(isLoopEnabled);
  
  if (isLoopEnabled) {
    loopBtn.classList.add("btn--info");
  } else {
    loopBtn.classList.remove("btn--info");
  }
}

var debouncedUpdateSettings = debounce(updateSettings, 300);

function renderStatus(text, tone) {
  if (!tone) tone = "neutral";
  if (!statusPill) return;
  statusPill.textContent = text;
  statusPill.className = "pill pill--" + tone;
}

var MAX_LOG_ENTRIES = 50;

function appendStatusLog(message) {
  if (!statusLogEl) return;
  var entry = document.createElement("li");
  entry.textContent = "[" + new Date().toLocaleTimeString() + "] " + message;
  statusLogEl.insertBefore(entry, statusLogEl.firstChild);
  
  while (statusLogEl.children.length > MAX_LOG_ENTRIES) {
    statusLogEl.removeChild(statusLogEl.lastChild);
  }
}

function setActiveSlide(index, reason) {
  if (!reason) reason = "manual";
  if (!state.slides.length) return;
  var clamped = Math.max(0, Math.min(index, state.slides.length - 1));
  if (clamped === state.activeSlideIndex) return;
  state.activeSlideIndex = clamped;
  renderPreview();
  persistState(reason);
}

function handleNextSlide(reason) {
  if (!reason) reason = "manual";
  if (!state.slides.length) return;
  
  var nextIndex = state.activeSlideIndex + 1;
  
  if (nextIndex >= state.slides.length) {
    if (state.playlist && state.playlist.loop) {
      setActiveSlide(0, reason);
      appendStatusLog("Loop: returned to first slide.");
    }
  } else {
    setActiveSlide(nextIndex, reason);
  }
}

var pendingScript = null;

function pollLuaCommands() {
  if (pendingScript) return;
  
  pendingScript = document.createElement("script");
  pendingScript.src = "./hotkeys.js?t=" + Date.now();
  pendingScript.onload = function() {
    var payload = window.__obsTextSlidesHotkey;
    if (payload && typeof payload.seq === "number" && payload.seq > luaSeq) {
      luaSeq = payload.seq;
      if (payload.command === "next") {
        handleNextSlide("lua-next");
      } else if (payload.command === "prev") {
        setActiveSlide(state.activeSlideIndex - 1, "lua-prev");
      } else if (payload.command === "first") {
        setActiveSlide(0, "lua-first");
      } else if (typeof payload.command === "number") {
        setActiveSlide(payload.command, "lua-jump");
      }
    }
    if (pendingScript) {
      pendingScript.remove();
      pendingScript = null;
    }
  };
  pendingScript.onerror = function() {
    if (pendingScript) {
      pendingScript.remove();
      pendingScript = null;
    }
  };
  document.body.appendChild(pendingScript);
}

function init() {
  if (insertDelimiterBtn) insertDelimiterBtn.addEventListener("click", insertDelimiter);
  if (addSlidesBtn) addSlidesBtn.addEventListener("click", addSlides);
  if (clearAllBtn) clearAllBtn.addEventListener("click", clearAllSlides);
  if (loopBtn) loopBtn.addEventListener("click", toggleLoop);
  if (fontSelect) fontSelect.addEventListener("change", function() { updateSettings("font family"); });
  if (fontSizeInput) fontSizeInput.addEventListener("input", function() { debouncedUpdateSettings("font size"); });
  if (textAlignSelect) textAlignSelect.addEventListener("change", function() { updateSettings("horizontal alignment"); });
  if (verticalAlignSelect) verticalAlignSelect.addEventListener("change", function() { updateSettings("vertical alignment"); });
  
  if (colorTriggerBtn) colorTriggerBtn.addEventListener("click", showColorPicker);
  
  if (textColorInput) {
    textColorInput.addEventListener("input", function() {
      if (textColorHexInput) textColorHexInput.value = textColorInput.value;
      updateColorSwatch();
      debouncedUpdateSettings("text color");
    });
  }
  
  if (textColorHexInput) {
    textColorHexInput.addEventListener("change", function() {
      var val = textColorHexInput.value;
      if (/^#[0-9A-F]{6}$/i.test(val)) {
        if (textColorInput) textColorInput.value = val;
        updateColorSwatch();
        updateSettings("text color hex");
      }
    });
  }

  if (textOpacityInput) {
    textOpacityInput.addEventListener("input", function() {
      if (textOpacityValue) textOpacityValue.textContent = textOpacityInput.value + "%";
      updateColorSwatch();
      debouncedUpdateSettings("text opacity");
    });
  }
  
  document.addEventListener("click", function(e) {
    if (colorPickerPopover && !colorPickerPopover.hidden) {
      if (!colorPickerPopover.contains(e.target) && colorTriggerBtn && !colorTriggerBtn.contains(e.target)) {
        hideColorPicker();
      }
    }
  });
  
  if (colorPickerBackdrop) colorPickerBackdrop.addEventListener("click", hideColorPicker);

  if (shadowIntensityInput) shadowIntensityInput.addEventListener("input", function() { debouncedUpdateSettings("shadow intensity"); });
  if (strokeIntensityInput) strokeIntensityInput.addEventListener("input", function() { debouncedUpdateSettings("stroke intensity"); });
  if (transitionTypeSelect) transitionTypeSelect.addEventListener("change", function() { updateSettings("transition type"); });
  if (transitionDurationInput) transitionDurationInput.addEventListener("input", function() { debouncedUpdateSettings("transition duration"); });

  applyStateToUi();
  renderStatus("Ready", "success");
  appendStatusLog("Dock ready. Add slides using the editor.");
  channel.postMessage({ type: "state", source: "dock-ui", payload: state });
  setInterval(pollLuaCommands, 1000);
}

init();
    </script>
  </body>
</html>
